user nginx;
worker_processes auto;
pid /run/nginx.pid;

error_log /var/log/nginx/error.log warn;
include /usr/share/nginx/modules/*.conf;

events {
    worker_connections 1024;
    multi_accept on;
}

http {
    # -------------------------------------------------------------------------
    #  Logging  (Web Server STIG V2R8)
    # -------------------------------------------------------------------------
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    access_log /var/log/nginx/access.log main;

    # -------------------------------------------------------------------------
    #  Core hardening
    # -------------------------------------------------------------------------
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 60;
    types_hash_max_size 4096;
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    server_tokens off;              # Hide NGINX version  (V 222380)
    reset_timedout_connection on;
    client_body_timeout 10s;
    client_header_timeout 10s;
    send_timeout 30s;
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;
    limit_conn conn_limit 100;
    gzip off;                       # Disable compression per STIG

    # Extract CN from subject DN  -- allows nginx to use the cac variables
    map $ssl_client_s_dn $ssl_client_cn {
        default "";
        ~CN=(?<CN>[^,]+) $CN;
    }


    # -------------------------------------------------------------------------
    #  HTTP â†’ HTTPS redirect --- disabled, no reason to have it
    # -------------------------------------------------------------------------
    #server {
    #    listen 80 default_server;
    #    server_name _;
    #    return 301 https://$host$request_uri;
    #}

    # -------------------------------------------------------------------------
    #  Default HTTPS catch all  (least privilege)
    # -------------------------------------------------------------------------
    server {
        listen 443 ssl default_server;
        server_name _;
        ssl_certificate     /etc/pki/tls/ssl.crt;
        ssl_certificate_key /etc/pki/tls/ssl.key;
        #return 444;                 # Drop unmatched traffic
    }

    # -------------------------------------------------------------------------
    #  Reverse Proxy for NiFi  (internal only)
    # -------------------------------------------------------------------------
    server {
        listen 443 ssl http2;
        server_name nifi.ogs18.ogs.mi.ds.army.smil.mil;

        # ---------------------------------------------------------------------
        #  TLS / FIPS Approved configuration
        # ---------------------------------------------------------------------
        ssl_certificate     /etc/pki/tls/ssl.crt;
        ssl_certificate_key /etc/pki/tls/ssl.key;


        ssl_protocols TLSv1.3 TLSv1.2;
        ssl_ciphers 'HIGH:!aNULL:!MD5:!3DES:!RC4';
        ssl_conf_command Ciphersuites TLS_AES_256_GCM_SHA384:TLS_AES_128_GCM_SHA256;
        ssl_prefer_server_ciphers on;
        ssl_ecdh_curve prime256v1;      # FIPSapproved
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        # ---------------------------------------------------------------------
        #  Security HTTP headers  (STIG V222385)
        # ---------------------------------------------------------------------
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "no-referrer" always;
        add_header Permissions-Policy "geolocation=(), microphone=()" always;

        # ---------------------------------------------------------------------
        #  Error page isolation
        # ---------------------------------------------------------------------
        error_page 400 401 403 404 500 502 503 504 /error.html;
        location = /error.html {
            root /usr/share/nginx/html;
            internal;
        }

        access_log /var/log/nginx/nifi.ogs18.ogs.mi.ds.army.smil.mil.access.log main;
        error_log  /var/log/nginx/nifi.ogs18.ogs.mi.ds.army.smil.mil.error.log warn;

        client_max_body_size 100M;
        proxy_read_timeout   600s;
        proxy_send_timeout   600s;

        # ---------------------------------------------------------------------
        #  Reverse Proxy path to NiFi
        # ---------------------------------------------------------------------
        location / {
            proxy_pass https://localhost:8443/;

            proxy_ssl_protocols TLSv1.3 TLSv1.2;
            proxy_ssl_conf_command Ciphersuites TLS_AES_256_GCM_SHA384:TLS_AES_128_GCM_SHA256;
            proxy_ssl_verify off;        # self signed NiFi internal cert
            proxy_ssl_verify_depth 1;

            proxy_set_header Host              $host;
            proxy_set_header X-Forwarded-Host  $host;
            proxy_set_header X-Forwarded-Port  $server_port;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;

            proxy_http_version 1.1;
            proxy_request_buffering off;
        }
    }

    # -------------------------------------------------------------------------
    #  Reverse Proxy for ZFTS (DoD PKI/CAC protected)
    # -------------------------------------------------------------------------
    server {
        listen 443 ssl http2;
        server_name zfts.ogs18.ogs.mi.ds.army.smil.mil 192.168.10.212;  # Update IP if needed

        # ---------------------------------------------------------------------
        #  TLS / FIPS approved configuration
        # ---------------------------------------------------------------------
        ssl_certificate     /etc/pki/tls/ssl.zfts.crt;
        ssl_certificate_key /etc/pki/tls/ssl.zfts.key;

        ssl_protocols TLSv1.3 TLSv1.2;
        ssl_ciphers 'HIGH:!aNULL:!MD5:!3DES:!RC4';
        ssl_conf_command Ciphersuites TLS_AES_256_GCM_SHA384:TLS_AES_128_GCM_SHA256;
        ssl_prefer_server_ciphers on;
        ssl_ecdh_curve prime256v1;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
	    ssl_session_tickets off;
        # ---------------------------------------------------------------------
        #  Enforce DoD PKI / CAC authentication
        # ---------------------------------------------------------------------
        ssl_client_certificate /etc/pki/ca-trust/extracted/pem/DOD_CAs.pem;   # DoD CA bundle
        ssl_verify_client on;        # Require CAC / client certificate
        ssl_verify_depth 1; #1 is server checks client, recommended without proper ssl cert. #2 both client and server verify each others ssl

        # ---------------------------------------------------------------------
        #  Security HTTP headers  (STIG V 222385)
        # ---------------------------------------------------------------------
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "no-referrer" always;
        add_header Permissions-Policy "geolocation=(), microphone=()" always;

        # ---------------------------------------------------------------------
        #  Logging
        # ---------------------------------------------------------------------
        #log_format pki '$remote_addr - $ssl_client_s_dn [$time_local] "$request" $status $body_bytes_sent "$http_user_agent"';
        access_log /var/log/nginx/zfts.ogs18.ogs.mi.ds.army.smil.mil.access.log;
        error_log  /var/log/nginx/zfts.ogs18.ogs.mi.ds.army.smil.mil.error.log warn;

        client_max_body_size 100M;
        proxy_read_timeout   600s;
        proxy_send_timeout   600s;

    	location /userinfo {
            default_type application/json;
	        add_header Cache-Control "private, max-age=60";
            return 200 '{"cn":"$ssl_client_cn","dn":"$ssl_client_s_dn"}';
        }


        location /airproxy {
            # Extract query args
            set $target "";
            if ($arg_target) { set $target $arg_target; }

            set $path "";
            if ($arg_path) { set $path $arg_path; }

            # Allow only expected patterns discovered in stats.js
            if ($args !~* "target=.*?:19712&path=(files|files\.sse|files/[0-9]+)$") {
                return 403;
            }

            # Restrict HTTP methods
            if ($request_method !~ ^(GET|POST|OPTIONS)$) {
                return 405;
            }

            # Require JSON for POST calls
            # Reject non JSON POST requests (completely flat logic)
            if ($request_method = POST) { set $is_post 1; }
            if ($is_post = 1) { set $bad_json 1; }
            if ($http_content_type ~* "application/json") { set $bad_json 0; }
            if ($bad_json = 1) { return 415; }

            # Preflight
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "*" always;
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
                add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
                return 204;
            }

            # Proxy request safely
            set $dest http://$target/$path;

            proxy_pass $dest;
            proxy_ssl_verify off;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Connection '';

            # SSE fragmentation
            proxy_buffering off;
            proxy_request_buffering off;
            tcp_nodelay on;

            # No caching
            add_header Cache-Control "no-cache, no-store, must-revalidate" always;
            add_header Pragma "no-cache" always;
            add_header Expires "0" always;


        }

        # ---------------------------------------------------------------------
        #  Reverse Proxy to internal ZFTS service
        # ---------------------------------------------------------------------
        location / {
            proxy_pass http://127.0.0.1:19012/;
            proxy_http_version 1.1;

            proxy_set_header Accept-Encoding "";
            proxy_set_header Host              $host;
            proxy_set_header X-Forwarded-Host  $host;
            proxy_set_header X-Forwarded-Port  $server_port;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_ssl_session_reuse off;

	    types {
		    application/javascript js;
		    test/css css;
	    }
            default_type application/javascript;

        # override upstream text/plain for .js (the stock zfts sends it as plain text instead of application/javascript which breaks it)
            if ($request_uri ~* "\.js$") {
                add_header Content-Type application/javascript always;
             }
        }
        # ---------------------------------------------------------------------
        #  Error isolation pages
        # ---------------------------------------------------------------------
        error_page 400 401 403 404 500 502 503 504 /error.html;
        location = /error.html {
            root /usr/share/nginx/html;
            internal;
        }
    }
}
